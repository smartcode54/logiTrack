# LogiTrack Project - Cursor Rules
# ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞ best practices ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå

## üî¥ Critical Errors to Avoid

### 1. Firebase Cloud Functions Naming Convention
**ERROR**: ‡πÉ‡∏ä‡πâ camelCase ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö function names (‡πÄ‡∏ä‡πà‡∏ô `reverseGeocode`)
**FIX**: ‡πÉ‡∏ä‡πâ snake_case ‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô `reverse_geocode`)
**REASON**: Cloud Run service names ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö camelCase ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î error "Could not create Cloud Run service"

```typescript
// ‚ùå WRONG
export const reverseGeocode = onCall(...);

// ‚úÖ CORRECT
export const reverse_geocode = onCall(...);
```

### 2. Error Handling in Cloud Functions
**ERROR**: ‡πÉ‡∏ä‡πâ `throw new Error()` ‡πÉ‡∏ô Cloud Functions
**FIX**: ‡πÉ‡∏ä‡πâ `throw new HttpsError()` ‡πÄ‡∏™‡∏°‡∏≠
**REASON**: HttpsError ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CORS ‡πÅ‡∏•‡∏∞ error response format ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

```typescript
// ‚ùå WRONG
throw new Error("Something went wrong");

// ‚úÖ CORRECT
throw new HttpsError("internal", "Something went wrong");
```

### 3. Content Security Policy (CSP)
**ERROR**: ‡∏•‡∏∑‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° Firebase Functions URLs ‡πÉ‡∏ô CSP
**FIX**: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° `https://*.cloudfunctions.net` ‡πÉ‡∏ô `connect-src`
**REASON**: Browser ‡∏à‡∏∞ block requests ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Cloud Functions

```typescript
// ‚úÖ CORRECT - next.config.ts ‡πÅ‡∏•‡∏∞ firebase.json
"connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.google.com https://api.geoapify.com https://www.google.com https://www.gstatic.com https://www.googletagmanager.com https://www.google-analytics.com https://content-firebaseappcheck.googleapis.com https://*.cloudfunctions.net"
```

### 4. Firebase Admin Initialization
**ERROR**: ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ admin ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
**FIX**: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `admin.apps.length` ‡∏Å‡πà‡∏≠‡∏ô initialize
**REASON**: ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î error ‡∏ñ‡πâ‡∏≤ initialize ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á

```typescript
// ‚úÖ CORRECT
import * as admin from "firebase-admin";

if (!admin.apps.length) {
  admin.initializeApp();
}

const db = admin.firestore();
const storage = admin.storage();
```

### 5. Import Ordering (Biome)
**ERROR**: Import statements ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° Biome rules
**FIX**: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á imports ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö: external packages (alphabetical) > internal modules
**REASON**: Biome ‡∏à‡∏∞ error ‡∏ñ‡πâ‡∏≤ imports ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö

```typescript
// ‚úÖ CORRECT
import * as admin from "firebase-admin";
import { HttpsError, onCall } from "firebase-functions/v2/https";
```

### 6. Geoapify API Parameters
**ERROR**: ‡πÉ‡∏ä‡πâ `lang` parameter ‡πÉ‡∏ô Reverse Geocoding API
**FIX**: ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ `lang` parameter (API ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
**REASON**: ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î 400 Bad Request error

```typescript
// ‚ùå WRONG
const params = new URLSearchParams({ apiKey, lat: latitude.toString(), lon: longitude.toString(), lang: "th" });

// ‚úÖ CORRECT
const params = new URLSearchParams({ apiKey, lat: latitude.toString(), lon: longitude.toString() });
```

### 7. PowerShell Scripts
**ERROR**: ‡πÉ‡∏ä‡πâ emoji characters ‡πÉ‡∏ô PowerShell scripts
**FIX**: ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ emoji (‡πÉ‡∏ä‡πâ plain text ‡πÅ‡∏ó‡∏ô)
**REASON**: PowerShell ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î parsing error

```powershell
# ‚ùå WRONG
echo "üöÄ Starting..."

# ‚úÖ CORRECT
echo "Starting..."
```

**ERROR**: ‡πÉ‡∏ä‡πâ `&&` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö command chaining ‡πÉ‡∏ô PowerShell
**FIX**: ‡πÉ‡∏ä‡πâ `;` ‡πÅ‡∏ó‡∏ô `&&`
**REASON**: PowerShell ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö `&&`

```powershell
# ‚ùå WRONG
cd functions && npm run build

# ‚úÖ CORRECT
cd functions; npm run build
```

### 8. Environment Variables Priority
**ERROR**: ‡πÉ‡∏ä‡πâ `functions.config()` ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
**FIX**: ‡πÉ‡∏ä‡πâ priority: `.env` (NEXT_PUBLIC_*) > environment variables > functions.config()
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö local development ‡πÅ‡∏•‡∏∞ deployment

```typescript
// ‚úÖ CORRECT
let apiKey = process.env.NEXT_PUBLIC_GEOAPIFY_API_KEY || process.env.GEOAPIFY_API_KEY;

if (!apiKey) {
  try {
    const functions = require("firebase-functions");
    const config = functions.config();
    apiKey = config?.geoapify?.api_key;
  } catch {
    // functions.config() not available, ignore
  }
}
```

### 9. Authentication in Cloud Functions
**ERROR**: ‡∏£‡∏±‡∏ö userId ‡πÄ‡∏õ‡πá‡∏ô parameter ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ auth context
**FIX**: ‡πÉ‡∏ä‡πâ `request.auth.uid` ‡∏à‡∏≤‡∏Å Cloud Function context
**REASON**: ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ spoof userId

```typescript
// ‚ùå WRONG
export const saveActivity = onCall(async (request) => {
  const { userId, activity } = request.data;
  // ...
});

// ‚úÖ CORRECT
export const saveActivity = onCall(async (request) => {
  if (!request.auth) {
    throw new HttpsError("unauthenticated", "User must be authenticated");
  }
  const userId = request.auth.uid;
  const { activity } = request.data;
  // ...
});
```

### 10. Base64 to Blob Conversion
**ERROR**: ‡πÉ‡∏ä‡πâ `fetch(base64)` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô client-side
**FIX**: ‡πÉ‡∏ä‡πâ proper base64 to buffer conversion ‡πÉ‡∏ô Cloud Functions
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

```typescript
// ‚úÖ CORRECT - Cloud Functions
const base64Data = base64String.replace(/^data:image\/\w+;base64,/, "");
const buffer = Buffer.from(base64Data, "base64");
```

### 11. Storage File Paths
**ERROR**: ‡πÉ‡∏ä‡πâ file paths ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
**FIX**: ‡πÉ‡∏ä‡πâ consistent path structure: `workflows/photos/{userId}/{jobId}/{workflowStep}/{fileName}`
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô conflicts

```typescript
// ‚úÖ CORRECT
const filePath = `workflows/photos/${userId}/${jobId}/${workflowStep}/${fileName}`;
```

### 12. Storage Public Access
**ERROR**: ‡∏•‡∏∑‡∏° make file public ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å upload
**FIX**: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `file.makePublic()` ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å upload
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ access ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å URL

```typescript
// ‚úÖ CORRECT
await file.save(buffer, { metadata: { ... } });
await file.makePublic();
return `https://storage.googleapis.com/${bucket.name}/${filePath}`;
```

### 13. Biome Formatting
**ERROR**: Multi-line console.error ‡πÅ‡∏•‡∏∞ variable assignments
**FIX**: ‡πÉ‡∏ä‡πâ single line ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö console.error ‡πÅ‡∏•‡∏∞ simple assignments
**REASON**: Biome formatter ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ single line

```typescript
// ‚ùå WRONG
console.error(
  `Error message:`,
  errorData
);

// ‚úÖ CORRECT
console.error(`Error message:`, errorData);
```

### 14. Unused Imports/Interfaces
**ERROR**: ‡∏™‡∏£‡πâ‡∏≤‡∏á interfaces ‡∏´‡∏£‡∏∑‡∏≠ imports ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ
**FIX**: ‡∏•‡∏ö unused code ‡∏≠‡∏≠‡∏Å
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡∏≠‡∏á code ‡πÅ‡∏•‡∏∞‡∏•‡∏î bundle size

### 15. Firebase Functions Region
**ERROR**: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ region ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cloud Functions
**FIX**: ‡∏£‡∏∞‡∏ö‡∏∏ region: `asia-southeast1` ‡πÄ‡∏™‡∏°‡∏≠
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ client ‡πÅ‡∏•‡∏∞ functions ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô region ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

```typescript
// ‚úÖ CORRECT
export const myFunction = onCall(
  {
    region: "asia-southeast1",
  },
  async (request) => {
    // ...
  }
);
```

### 16. Client-side Functions Config
**ERROR**: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ region ‡πÉ‡∏ô client-side functions config
**FIX**: ‡∏£‡∏∞‡∏ö‡∏∏ region ‡πÄ‡∏°‡∏∑‡πà‡∏≠ initialize functions
**REASON**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á region ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

```typescript
// ‚úÖ CORRECT
import { getFunctions } from "firebase/functions";
functions = getFunctions(app, "asia-southeast1");
```

### 17. TypeScript Node Protocol
**ERROR**: ‡πÉ‡∏ä‡πâ `require("path")` ‡πÅ‡∏ó‡∏ô `require("node:path")`
**FIX**: ‡πÉ‡∏ä‡πâ `node:` protocol ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö built-in modules
**REASON**: Biome linting rules

```typescript
// ‚ùå WRONG
require("path").join(...)

// ‚úÖ CORRECT
require("node:path").join(...)
```

## ‚úÖ Best Practices

### Code Organization
- ‡πÅ‡∏¢‡∏Å Cloud Functions ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏° domain (geocoding, workflow, etc.)
- ‡πÉ‡∏ä‡πâ consistent naming: snake_case ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö functions, camelCase ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö variables
- ‡πÅ‡∏¢‡∏Å client-side ‡πÅ‡∏•‡∏∞ server-side code ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô

### Error Handling
- ‡πÉ‡∏ä‡πâ HttpsError ‡πÉ‡∏ô Cloud Functions ‡πÄ‡∏™‡∏°‡∏≠
- Validate input data ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
- Log errors ‡∏û‡∏£‡πâ‡∏≠‡∏° context information

### Security
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Cloud Function
- ‡πÉ‡∏ä‡πâ `request.auth.uid` ‡πÅ‡∏ó‡∏ô userId parameter
- ‡∏≠‡∏¢‡πà‡∏≤ expose sensitive data ‡πÉ‡∏ô client-side code

### Performance
- ‡πÉ‡∏ä‡πâ Promise.all() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parallel operations
- Upload images ‡πÉ‡∏ô Cloud Functions ‡πÅ‡∏ó‡∏ô client-side
- ‡πÉ‡∏ä‡πâ proper caching strategies

### Testing
- ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Firebase Emulator ‡∏Å‡πà‡∏≠‡∏ô deploy
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö linting errors ‡∏Å‡πà‡∏≠‡∏ô commit
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSP ‡πÅ‡∏•‡∏∞ CORS settings

## üìù Checklist Before Deploy

- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö linting errors: `npm run lint`
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö function names ‡πÉ‡∏ä‡πâ snake_case
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSP configuration
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication checks
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö error handling ‡πÉ‡∏ä‡πâ HttpsError
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment variables
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö region configuration
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Firebase Emulator
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö unused imports/interfaces

## üö® Common Deployment Errors

1. **"Could not create Cloud Run service"** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö function name ‡πÉ‡∏ä‡πâ snake_case
2. **"CORS error"** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ä‡πâ HttpsError ‡πÅ‡∏•‡∏∞ CSP configuration
3. **"401 Unauthorized"** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication ‡πÅ‡∏•‡∏∞ API keys
4. **"Function not found"** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö function name ‡πÅ‡∏•‡∏∞ deployment status
5. **"Permission denied"** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase CLI login ‡πÅ‡∏•‡∏∞ project selection

